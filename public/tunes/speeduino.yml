---
apiVersion: '1.0'

signature: speeduino 202009-dev

pages:
  - number: 1
    size: 128
    constants:
      aseTaperTime:
        type: scalar
        size: U08
        offset: 0
        units: S
        scale: 0.1
        max: 25.5
      aeColdPct: # AE cold adjustment %
        type: scalar
        size: U08
        offset: 1
        units: '%'
        transform: 0
        min: 100
        max: 255
      aeColdTaperMin: # AE cold adjustment, taper start clt (full adjustment)
        type: scalar
        size: U08
        offset: 2
        units: C
        transform: -40
        min: -40
        max: 215
      aeMode:
        type: bits
        size: U08
        offset: 3
        address: '[0:1]'
        values: [TPS, MAP, INVALID, INVALID]
      battVCorMode:
        type: bits
        size: U08
        offset: 3
        address: '[2:2]'
        values: [Whole PW, Open Time only]
      SoftLimitMode:
        type: bits
        size: U08
        offset: 3
        address: '[3:3]'
        values: [Fixed, Relative ]
      unused1-3c:
        type: bits
        size: U08
        offset: 3
        address: '[4:4]'
        values: [MAP, TPS]
      aeApplyMode:
        type: bits
        size: U08
        offset: 3
        address: '[5:5]'
        values: [PW Multiplier, PW Adder]
      multiplyMAP:
        type: bits
        size: U08
        offset: 3
        address: '[6:7]'
        values: [Off, Baro, Fixed, INVALID]
      wueRates:
        type: array
        size:  U08
        offset: 4
        shape:
          columns: 10
        units: '%'
        max: 255
      crankingPct:
        type: scalar
        size: U08
        offset: 14
        units: '%'
        max: 255
      pinLayout:
        type: bits
        size: U08
        offset: 15
        address: '[0:7]'
        values: [Speeduino v0.1, Speeduino v0.2, Speeduino v0.3, Speeduino v0.4, INVALID, INVALID, 01-05 MX5 PNP, INVALID, 96-97 MX5 PNP, NA6 MX5 PNP, Turtana PCB, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, Plazomat I/O 0.1, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, Daz V6 Shield 0.1, BMW PnP, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, NO2C, UA4C, INVALID, INVALID, INVALID, DIY-EFI CORE4 v1.0, INVALID, INVALID, INVALID, INVALID, dvjcodec Teensy RevA, dvjcodec Teensy RevB, INVALID, INVALID, INVALID, Drop Bear, INVALID, INVALID, INVALID, INVALID, Black STM32F407VET6 V0.1, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID]
      tachoPin:
        type: bits
        size: U08
        offset: 16
        address: '[0:5]'
        values: [Board Default, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID]
      tachoDiv:
        type: bits
        size: U08
        offset: 16
        address: '[6:7]'
        values: [Normal, Half, INVALID, INVALID]
      tachoDuration:
        type: scalar
        size: U08
        offset: 17
        units: ms
        min: 1.0
        max: 6.0
      maeThresh: # MAP threshold for triggering AE
        type: scalar
        size: U08
        offset: 18
        units: kPa/s
        max: 255
      taeThresh: # TPS threshold for triggering AE
        type: scalar
        size: U08
        offset: 19
        units: '%/s'
        max: 255
      aeTime:
        type: scalar
        size: U08
        offset: 20
        units: ms
        scale: 10
        max: 2550
      reqFuel:
        type: scalar
        size: U08
        offset: 24
        units: ms
        scale: 0.1
        max: 25.5
      # divider:
      alternate:
        type: bits
        size: U08
        offset: 26
        address: '[0:0]'
        values: [Simultaneous, Alternating]
      multiplyMAP1:
        type: bits
        size: U08
        offset: 26
        address: '[1:1]'
        values: [No, Yes]
      includeAFR:
        type: bits
        size: U08
        offset: 26
        address: '[2:2]'
        values: [No, Yes]
      hardCutType:
        type: bits
        size: U08
        offset: 26
        address: '[3:3]'
        values: [Full, Rolling]
      ignAlgorithm:
        type: bits
        size: U08
        offset: 26
        address: '[4:6]'
        values: [MAP, TPS, IMAP/EMAP]
      indInjAng:
        type: bits
        size: U08
        offset: 26
        address: '[7:7]'
        values: [Disabled, Enabled]
      injOpen:
        type: scalar
        size: U08
        offset: 27
        units: ms
        scale: 0.1
        min: 0.1
        max: 25.5
      injAng:
        type: array
        size: U16
        offset: 28
        shape:
          columns: 4
        units: deg
        max: 720

      # Config1
      mapSample:
        type: bits
        size: U08
        offset: 36
        address: '[0:1]'
        values: [Instantaneous, Cycle Average, Cycle Minimum, Event Average]
      twoStroke:
        type: bits
        size: U08
        offset: 36
        address: '[2:2]'
        values: [Four-stroke, Two-stroke]
      injType:
        type: bits
        size: U08
        offset: 36
        address: '[3:3]'
        values: [Port, Throttle Body]
      nCylinders:
        type: bits
        size: U08
        offset: 36
        address: '[4:7]'
        values: [INVALID, 1, 2, 3, 4, 5, 6, INVALID, 8, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID]

      # Config2
      algorithm: # (TS) Has to be called algorithm for the req fuel calculator to work :(
        type: bits
        values: [MAP, TPS, IMAP/EMAP]
      fixAngEnable:
        type: bits
        size: U08
        offset: 37
        address: '[3:3]'
        values: [Off, On]
      nInjectors:
        type: bits
        size: U08
        offset: 37
        address: '[4:7]'
        values: [INVALID, 1, 2, 3, 4, 5, 6, INVALID, 8, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID]

      # Config3
      engineType:
        type: bits
        size: U08
        offset: 38
        address: '[0:0]'
        values: [Even fire, Odd fire]
      flexEnabled:
        type: bits
        size: U08
        offset: 38
        address: '[1:1]'
        values: [Off, On]
      legacyMAP:
        type: bits
        size: U08
        offset: 38
        address: '[2:2]'
        values: [No, Yes] # Whether to use the older legacy MAP reading that had the pullup enabled
      baroCorr:
        type: bits
        size: U08
        offset: 38
        address: '[3:3]'
        values: [Off, On]
      injLayout:
        type: bits
        size: U08
        offset: 38
        address: '[4:5]'
        values: [Paired, Semi-Sequential, INVALID, Sequential]
      perToothIgn:
        type: bits
        size: U08
        offset: 38
        address: '[6:6]'
        values: [No, Yes]
      dfcoEnabled:
        type: bits
        size: U08
        offset: 38
        address: '[7:7]'
        values: [Off, On]


      stoich:
        type: scalar
        units: :1
        max: 14.7
        min: 9
      oddfire2:
        type: scalar
        units: deg
      oddfire3:
        type: scalar
        units: deg
      oddfire4:
        type: scalar
        units: deg

      dutyLim:
        type: scalar
        units: '%'


  - number: 4
    size: 128
    constants:
      TrigPattern:
        type: bits
        size: U08
        offset: 5
        address: '[3:7]'
        values: [Missing Tooth, Basic Distributor, Dual Wheel, GM 7X, 4G63 / Miata / 3000GT, GM 24X, Jeep 2000, Audi 135, Honda D17, Miata 99-05, Mazda AU, Non-360 Dual, Nissan 360, Subaru 6/7, Daihatsu +1, Harley EVO, 36-2-2-2, 36-2-1, DSM 420a, Weber-Marelli, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID, INVALID]


dialogs:
  - name: engineConstants
    title: Engine Constants
    help:
      link: https://wiki.speeduino.com/en/configuration/Engine_Constants
    groups:
      - name: engineConstants
        title: Engine Constants
        fields:
          - name: reqFuel
            title: Required Fuel
          - name: algorithm
            title: Control Algorithm
            help: Fueling calculation algorithm
          - name: divider
            title: Squirts Per Engine Cycle
          - name: alternate
            title: Injector Staging
            help: |
              Whether or not the injectors should be fired at the same time.
              This setting is ignored when Sequential is selected below, however it will still affect req_fuel value.
          - name: twoStroke
            title: Engine Stroke
            help: Four-stroke (most engines), Two-stroke
          - name: nCylinders
            title: Number of Cylinders
            help: Cylinder count
          - name: injType
            title: Injector Port Type
            help: Port Injection (one injector for each cylinder) or Throttle Body (injectors shared by cylinders)
          - name: nInjectors
            title: Number of Injectors
            help: Number of primary injectors
          - name: engineType
            title: Engine Type
            help: |
              Engines with an equal number of degrees between all firings (This is most engines) should select Even fire.
              Some 2 and 6 cylinder engines are Odd fire however
      - name: board
        title: Board
        fields:
          - name: stoich
            title: Stoichiometric ratio
            help: |
              The stoichiometric ration of the fuel being used.
              For flex fuel, choose the primary fuel.
          - name: injLayout
            title: Injector Layout
            help: |
              The injector layout and timing to be used. Options are:
              1. Paired - 2 injectors per output. Outputs active is equal to half the number of cylinders. Outputs are timed over 1 crank revolution.
              2. Semi-sequential: Same as paired except that injector channels are mirrored (1&4, 2&3) meaning the number of outputs used are equal to the number of cylinders. Only valid for 4 cylinders or less.
              3. Banked: 2 outputs only used.
              4. Sequential: 1 injector per output and outputs used equals the number of cylinders. Injection is timed over full cycle.
          - name: pinLayout
            title: Board Layout
          - name: mapSample
            title: Map Sample method
            help: |
              The method used for calculating the MAP reading.
              - For 1-2 Cylinder engines, Cycle Minimum is recommended.
              - For more than 2 cylinders Cycle Average is recommended.
      - name: oddFireAngles
        title: Odd Fire Angles
        fields:
          - name: oddfire2
            title: Channel 2 angle
            help: |
              The ATDC angle of channel 2 for oddfire engines.
              This is relative to the TDC angle of channel 1
            condition: tune.engineType == 1
          - name: oddfire3
            title: Channel 3 angle
            help: |
              The ATDC angle of channel 3 for oddfire engines.
              This is relative to the TDC angle of channel 1 (NOT channel 2)
            condition: tune.engineType == 1 && tune.nCylinders >= 3
          - name: oddfire4
            title: Channel 4 angle
            help: |
              The ATDC angle of channel 4 for oddfire engines.
              This is relative to the TDC angle of channel 1 (NOT channel 3)
            condition: tune.engineType == 1 && tune.nCylinders >= 4

  - name: injectorCharacteristics
    title: Injector Characteristics
    help:
      link: https://wiki.speeduino.com/en/configuration/Injector_Characteristics
    groups:
      - name: injectorCharacteristics
        title: Injector Characteristics
        fields:
          - name: dutyLim
            title: Injector Duty Limit
      - name: injectorOpeningTime
        title: Injector opening time
        fields:
          - name: injOpen
            title: Injector Open Time
            help: |
              Injector dead time.
              The net time current is provided to the injector but is not injecting fuel due to opening and closing

  - name: triggerSettings
    title: Trigger Settings
    help:
      link: https://wiki.speeduino.com/en/decoders
    groups:
      - name: triggerSettings
        title: Trigger Settings
        fields:
          - name: TrigPattern
            title: Trigger Pattern
            help: The type of input trigger decoder to be used

menus:
  - name: settings
    title: Settings
    subMenus:
      - name: engineConstants
        title: Engine Constants
      - name: injectorCharacteristics
        title: Injector Characteristics
      - name: triggerSettings
        title: Trigger Settings
      - name: airDensity
        title: IAT Density
      - name: barometricCorrection
        title: Barometric Correction
      - name: resetControl
        title: Reset Control
      # - name: separator
      - name: gaugeLimits
        title: Gauge Limits
      # - name: separator
      - name: ioSummary
        title: I/O Summary
      # - name: separator
      - name: programmableOutputs
        title: Programmable outputs

  - name: tuning
    title: Tuning
    subMenus:
      - name: realtimeDisplay
        title: Realtime Display
      - name: accelerationEnrichment
        title: Acceleration Enrichment
      - name: aFRO2
        title: AFR/O2
      - name: engineProtection
        title: Engine Protection
      - name: flexFuel
        title: Flex Fuel
      - name: veTable
        title: VE Table
      - name: sparkTable
        title: Spark Table
      - name: afrTable
        title: AFR Table
      - name: secondFuelTable
        title: Second Fuel Table
      - name: secondSparkTable
        title: Second spark Table
      - name: sequentialFuelTrim
        title: Sequential Fuel trim
      - name: stagedInjection
        title: Staged Injection
      - name: fuelTempCorrection
        title: Fuel Temp Correction

  - name: spark
    title: Spark
    subMenus:
      - name: sparkSettings
        title: Spark Settings
      - name: sparkTable
        title: Spark Table
      - name: dwellSettings
        title: Dwell settings
      - name: dwellCompensation
        title: Dwell Compensation
      - name: iatRetard
        title: IAT Retard
      - name: coldAdvance
        title: Cold Advance
      - name: rotaryIgnition
        title: Rotary Ignition
        condition: sparkMode == 4
